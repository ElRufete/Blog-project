{% extends "blog/layout.html" %}
{% load django_bootstrap5 %}

    <title>Editar entrada</title>

{% block page_header %}

<div class="px-1 px-md-4 py-4 d-flex flex-column centered">
        <h1> Editar Entrada </h1>
</div>
{% endblock page_header %}


{% block content%}

    <div class="px-1 px-md-4 py-4 d-flex flex-column">
        <div class="centered adjusted blackboard py-4">
            <form action="{% url 'blog:edit_entry' entry.id %}" method='post' enctype="multipart/form-data">
                    {% csrf_token %}
                    {% bootstrap_form form %}
                    {{form.media}}

                    <script>

                        tinymce.init({
                            height: 400,
                            width: "100%",
                            selector: "textarea",
                            plugins: "image link",
                            menubar: true,
                            toolbar: "undo redo | bold italic underline | forecolor backcolor | fontfamily fontsize | " + 
                                    "alignleft aligncenter alignright alignjustify | " +
                                    "bullist numlist outdent indent | image link | ",

                            formats: {
                                    alignleft: {selector: 'p', styles: {'text-align':'left'}},
                                    aligncenter: {selector: 'p', styles: {'text-align':'center'}},
                                    alignright: {selector: 'p', styles: {'text-align':'right'}}
                                    },

                            style_formats: [
                                    {
                                        title: 'Image Left',
                                        selector: 'img',
                                        styles: {
                                            'float': 'left', 
                                            'margin': '0 10px 0 10px'
                                        }
                                    },
                                    {
                                        title: 'Image Right',
                                        selector: 'img', 
                                        styles: {
                                            'float': 'right', 
                                            'margin': '0 0 10px 10px'
                                        }
                                    }
                                ],

                            
                            extended_valid_elements: 'p[class|style],img[src|alt|width|height|class|style]',


                            paste_data_images: true,
                            
                            
                            images_upload_handler: (blobInfo) => {
                                return new Promise((resolve, reject) => {
                                    const xhr = new XMLHttpRequest();
                                    const formData = new FormData();

                                    xhr.open(
                                        "POST",
                                        "https://api.cloudinary.com/v1_1/drudyw2gl/image/upload",
                                        true
                                    );

                                    xhr.onload = () => {
                                        if (xhr.status !== 200) {
                                            reject(xhr.responseText);
                                            return;
                                        }

                                        const json = JSON.parse(xhr.responseText);
                                        resolve(json.secure_url);
                                    };

                                    xhr.onerror = () => reject("Upload failed");

                                    formData.append("file", blobInfo.blob());
                                    formData.append("upload_preset", "tinymce_media_upload");

                                    xhr.send(formData);
                                });
                            }
                        });

                    </script>

                    {% bootstrap_button button_type="submit" content="Editar" %}
            </form>
        </div>
    </div>

{%endblock content%}